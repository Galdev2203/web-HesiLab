<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff del equipo</title>

  <style>
    body { font-family: Arial; padding: 20px; }
    .staff-card {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .btn { 
      padding: 8px 12px; 
      border-radius: 6px; 
      border: none;
      cursor: pointer;
    }
    .primary { background: #2b8aef; color: white; }
    .danger { background: #d9534f; color: white; }
    #addBox { margin-top: 20px; }
    select { padding: 6px; }
  </style>
</head>
<body>

<h2>Entrenadores del equipo</h2>
<p id="errorMsg" style="color:red;"></p>

<div id="staffList">Cargando staff...</div>

<hr>

<div id="addBox">
  <h3>A√±adir entrenador</h3>
  <input id="emailInput" placeholder="Email del entrenador" style="width:60%; padding:6px;" />
  <select id="roleInput" style="padding:6px;">
    <option value="segundo">Segundo</option>
    <option value="ayudante" selected>Ayudante</option>
  </select>
  <button id="addBtn" class="btn primary">A√±adir</button>
</div>

<script type="module">
  import { supabase } from "./supabaseClient.js";

  // Validar sesi√≥n
  const { data: sessionData } = await supabase.auth.getSession();
  if (!sessionData.session) {
    window.location.href = "/index.html";
    throw new Error("No session");
  }
  const user = sessionData.session.user;

  // Obtener team_id
  const params = new URLSearchParams(window.location.search);
  const teamId = params.get("team_id");

  if (!teamId) {
    document.getElementById("errorMsg").innerText = "Error: falta team_id.";
    throw new Error("Missing team_id");
  }

  // Comprobar permisos del usuario (qu√© rol tiene en este equipo)
  const { data: permission, error: permErr } = await supabase
    .from("team_staff")
    .select("id, role")
    .eq("team_id", teamId)
    .eq("user_id", user.id)
    .eq("active", true);

  if (permErr || !permission || permission.length === 0) {
    document.getElementById("errorMsg").innerText = "No tienes permiso para ver este equipo.";
    throw new Error("No permission");
  }

  const myRole = permission[0].role;

  // =====================================================
  // üî• Cargar staff
  // =====================================================
  async function loadStaff() {
    const container = document.getElementById("staffList");
    container.innerText = "Cargando...";

    const { data, error } = await supabase
      .from("team_staff")
      .select("id, role, user_id, profiles(id, email)")
      .eq("team_id", teamId)
      .eq("active", true);

    if (error) {
      container.innerText = "Error cargando staff.";
      console.error(error);
      return;
    }

    container.innerHTML = "";

    data.forEach(staff => {
      const div = document.createElement("div");
      div.className = "staff-card";

      // selector de roles + bot√≥n guardar
      const roleEditor = `
        <select class="roleSelect" data-id="${staff.id}">
          <option value="principal" ${staff.role === "principal" ? "selected" : ""}>Principal</option>
          <option value="segundo" ${staff.role === "segundo" ? "selected" : ""}>Segundo</option>
          <option value="ayudante" ${staff.role === "ayudante" ? "selected" : ""}>Ayudante</option>
        </select>
        <button class="btn primary saveRoleBtn" data-id="${staff.id}">Guardar rol</button>
      `;

      div.innerHTML = `
        <div>
          <strong>${staff.profiles?.email || "(sin email)"}</strong><br>
          <small>Rol actual: ${staff.role}</small>
        </div>

        <div style="display:flex; align-items:center;">
          ${roleEditor}
          <button class="btn danger deleteBtn" data-id="${staff.id}" data-user="${staff.user_id}">
            Eliminar
          </button>
        </div>
      `;

      const deleteBtn = div.querySelector(".deleteBtn");
      const selectRole = div.querySelector(".roleSelect");
      const saveRoleBtn = div.querySelector(".saveRoleBtn");

      // =====================================================
      // üî• REGLAS DE PERMISOS PARA EDITAR ROLES / ELIMINAR
      // =====================================================

      // 1) Si NO soy principal ‚Üí no edito nada
      if (myRole !== "principal") {
        deleteBtn.style.display = "none";
        selectRole.style.display = "none";
        saveRoleBtn.style.display = "none";
      }

      // 2) El principal NO puede cambiarse su propio rol
      if (staff.user_id === user.id) {
        selectRole.style.display = "none";
        saveRoleBtn.style.display = "none";
        deleteBtn.style.display = "none"; 
      }

      // A√±adir tarjeta
      container.appendChild(div);
    });

    // =====================================================
    // üî• Guardar cambios de rol
    // =====================================================
    document.querySelectorAll(".saveRoleBtn").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute("data-id");
        const newRole = btn.parentElement.querySelector(".roleSelect").value;

        // Evitar que el principal cambie su propio rol
        const { data: staffRow } = await supabase
          .from("team_staff")
          .select("user_id")
          .eq("id", id)
          .single();

        if (staffRow.user_id === user.id) {
          alert("No puedes cambiar tu propio rol porque eres el entrenador principal.");
          return;
        }

        const { error } = await supabase
          .from("team_staff")
          .update({ role: newRole })
          .eq("id", id);

        if (error) {
          alert("Error actualizando rol: " + error.message);
          return;
        }

        alert("Rol actualizado correctamente.");
        loadStaff();
      };
    });

    // =====================================================
    // üî• Eliminar miembro del staff
    // =====================================================
    document.querySelectorAll(".deleteBtn").forEach(btn => {
      btn.onclick = async () => {
        const userIdToDelete = btn.getAttribute("data-user");

        if (userIdToDelete === user.id) {
          alert("No puedes eliminarte a ti mismo.");
          return;
        }

        if (!confirm("¬øEliminar este entrenador del equipo?")) return;

        const id = btn.getAttribute("data-id");

        const { error } = await supabase
          .from("team_staff")
          .delete()
          .eq("id", id);

        if (error) {
          alert("Error eliminando entrenador: " + error.message);
          return;
        }

        loadStaff();
      };
    });
  }

  loadStaff();

  // =====================================================
  // üî• A√±adir entrenador
  // =====================================================
  document.getElementById("addBtn").onclick = async () => {
    const email = document.getElementById("emailInput").value.trim();
    const role = document.getElementById("roleInput").value;

    if (!email) {
      alert("Introduce un correo electr√≥nico.");
      return;
    }

    // Buscar usuario por email (RPC)
    const { data: usr, error } = await supabase.rpc("get_user_by_email", { p_email: email });

    if (error || !usr || usr.length === 0) {
      alert("No existe ning√∫n usuario con ese email.");
      return;
    }

    const userIdToAdd = usr[0].id;

    const { error: insertErr } = await supabase
      .from("team_staff")
      .insert({
        team_id: teamId,
        user_id: userIdToAdd,
        role: role
      });

    if (insertErr) {
      alert("No tienes permiso para a√±adir entrenadores.");
      return;
    }

    document.getElementById("emailInput").value = "";
    loadStaff();
  };
</script>

</body>
</html>
