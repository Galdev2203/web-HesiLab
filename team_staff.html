<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff del equipo</title>

  <style>
    body { font-family: Arial; padding: 20px; }
    .staff-card {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .btn { 
      padding: 8px 12px; 
      border-radius: 6px; 
      border: none;
      cursor: pointer;
    }
    .primary { background: #2b8aef; color: white; }
    .danger { background: #d9534f; color: white; }
    #addBox { margin-top: 20px; }
  </style>
</head>
<body>

<h2>Entrenadores del equipo</h2>
<p id="errorMsg" style="color:red;"></p>

<div id="staffList">Cargando staff...</div>

<hr>

<div id="addBox">
  <h3>A√±adir entrenador</h3>
  <input id="emailInput" placeholder="Email del entrenador" style="width:60%; padding:6px;" />
  <select id="roleInput" style="padding:6px;">
    <option value="segundo">Segundo</option>
    <option value="ayudante" selected>Ayudante</option>
  </select>
  <button id="addBtn" class="btn primary">A√±adir</button>
</div>

<script type="module">
  import { supabase } from "./supabaseClient.js";

  // Validar sesi√≥n
  const { data: sessionData } = await supabase.auth.getSession();
  if (!sessionData.session) {
    window.location.href = "/index.html";
    throw new Error("No session");
  }
  const user = sessionData.session.user;

  // Obtener team_id
  const params = new URLSearchParams(window.location.search);
  const teamId = params.get("team_id");

  if (!teamId) {
    document.getElementById("errorMsg").innerText = "Error: falta team_id.";
    throw new Error("Missing team_id");
  }

  // Comprobar permisos del usuario (qu√© rol tiene en este equipo)
  const { data: permission, error: permErr } = await supabase
    .from("team_staff")
    .select("id, role")
    .eq("team_id", teamId)
    .eq("user_id", user.id)
    .eq("active", true);

  if (permErr || !permission || permission.length === 0) {
    document.getElementById("errorMsg").innerText = "No tienes permiso para ver este equipo.";
    throw new Error("No permission");
  }

  const myRole = permission[0].role;

  // üîπ Funci√≥n para cargar el staff actual
  async function loadStaff() {
    const container = document.getElementById("staffList");
    container.innerText = "Cargando...";

    const { data, error } = await supabase
      .from("team_staff")
      .select("id, role, user_id, profiles(id, email)")
      .eq("team_id", teamId)
      .eq("active", true);

    if (error) {
      container.innerText = "Error cargando staff.";
      console.error(error);
      return;
    }

    container.innerHTML = "";

    data.forEach(staff => {
      const div = document.createElement("div");
      div.className = "staff-card";

      div.innerHTML = `
        <div>
          <strong>${staff.profiles?.email || "(sin email)"}</strong><br>
          <small>Rol: ${staff.role}</small>
        </div>
        <button class="btn danger" data-id="${staff.id}" data-user="${staff.user_id}">Eliminar</button>
      `;

      const deleteBtn = div.querySelector(".danger");

      // üî• REGLAS DE VISIBILIDAD DEL BOT√ìN ELIMINAR

      // 1) Si no soy principal ‚Üí no puedo eliminar a nadie
      if (myRole !== "principal") {
        deleteBtn.style.display = "none";

      // 2) Si soy principal:
      } else {
        // ‚ö†Ô∏è No puedo eliminarme a m√≠ mismo
        if (staff.user_id === user.id) {
          deleteBtn.style.display = "none";
        }
        // Un principal s√≠ puede borrar a segundos o ayudantes
      }

      container.appendChild(div);
    });

    // Bot√≥n eliminar
    document.querySelectorAll("button.danger").forEach(btn => {
      btn.onclick = async () => {
        const userIdToDelete = btn.getAttribute("data-user");

        // ‚ö†Ô∏è Protecci√≥n adicional (doble check)
        if (userIdToDelete === user.id) {
          alert("No puedes eliminarte a ti mismo porque eres el entrenador principal.");
          return;
        }

        if (!confirm("¬øEliminar este entrenador del equipo?")) return;

        const id = btn.getAttribute("data-id");

        const { error } = await supabase
          .from("team_staff")
          .delete()
          .eq("id", id);

        if (error) {
          alert("Error eliminando entrenador: " + error.message);
          return;
        }

        loadStaff();
      };
    });
  }

  loadStaff();

  // üîπ A√±adir entrenador
  document.getElementById("addBtn").onclick = async () => {
    const email = document.getElementById("emailInput").value.trim();
    const role = document.getElementById("roleInput").value;

    if (!email) {
      alert("Introduce un correo electr√≥nico.");
      return;
    }

    // Buscar usuario por email (RPC)
    const { data: usr, error } = await supabase.rpc("get_user_by_email", { p_email: email });

    if (error || !usr || usr.length === 0) {
      alert("No existe ning√∫n usuario con ese email.");
      return;
    }

    const userIdToAdd = usr[0].id;

    const { error: insertErr } = await supabase
      .from("team_staff")
      .insert({
        team_id: teamId,
        user_id: userIdToAdd,
        role: role
      });

    if (insertErr) {
      alert("No tienes permiso para a√±adir entrenadores.");
      return;
    }

    document.getElementById("emailInput").value = "";
    loadStaff();
  };
</script>

</body>
</html>
