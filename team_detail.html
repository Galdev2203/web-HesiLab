<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Equipo</title>

  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }
    .btn {
      display: block;
      margin: 12px 0;
      padding: 12px;
      background: #2b8aef;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      text-align: center;
      font-size: 16px;
      text-decoration: none;
    }
    .danger {
      background: #d9534f;
    }
  </style>
</head>

<body>

<h2 id="teamTitle">Cargando equipo...</h2>
<p id="teamCategory"></p>

<div id="actions" style="display:none;">
  <a id="playersBtn" class="btn">Jugadoras</a>
  <a id="staffBtn" class="btn">Entrenadores</a>
  <a id="attendanceBtn" class="btn">Pasar asistencia</a>
</div>

<p id="errorMessage" style="color:red;"></p>

<script type="module">
  import { supabase } from "./supabaseClient.js";

  // Validar sesi√≥n
  const { data: sessionData } = await supabase.auth.getSession();
  if (!sessionData.session) {
    window.location.href = "/index.html";
    throw new Error("No session");
  }
  const user = sessionData.session.user;

  // Obtener team_id de la URL
  const params = new URLSearchParams(window.location.search);
  const teamId = params.get("team_id");

  if (!teamId) {
    document.getElementById("errorMessage").innerText = "Error: no se ha proporcionado team_id.";
    throw new Error("Missing team_id");
  }

  // Comprobar que el usuario es staff del equipo
  const { data: staffData, error: staffError } = await supabase
    .from("team_staff")
    .select("id")
    .eq("team_id", teamId)
    .eq("user_id", user.id)
    .eq("active", true);

  if (staffError) {
    document.getElementById("errorMessage").innerText = "Error al comprobar permisos.";
    console.error(staffError);
    throw new Error("Staff check failed");
  }

  if (!staffData || staffData.length === 0) {
    document.getElementById("errorMessage").innerText = "No tienes permisos para acceder a este equipo.";
    throw new Error("No permission");
  }

  // Cargar datos del equipo
  const { data: teamData, error: teamError } = await supabase
    .from("teams")
    .select("*")
    .eq("id", teamId)
    .single();

  if (teamError || !teamData) {
    document.getElementById("errorMessage").innerText = "No se pudo cargar el equipo.";
    console.error(teamError);
    throw new Error("Team not found");
  }

  // Mostrar datos en pantalla
  document.getElementById("teamTitle").innerText = teamData.name;
  document.getElementById("teamCategory").innerText = teamData.category || "";

  // Mostrar botones y configurar enlaces
  document.getElementById("actions").style.display = "block";

  document.getElementById("playersBtn").href = `/team_players.html?team_id=${teamId}`;
  document.getElementById("staffBtn").href = `/team_staff.html?team_id=${teamId}`;
  document.getElementById("attendanceBtn").href = `/attendance.html?team_id=${teamId}`;
</script>

</body>
</html>
